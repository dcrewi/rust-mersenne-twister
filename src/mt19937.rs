// src/mt19937.rs
//
// Copyright (c) 2015,2017 rust-mersenne-twister developers
//
// Licensed under the Apache License, Version 2.0
// <LICENSE-APACHE or http://www.apache.org/licenses/LICENSE-2.0> or the MIT
// license <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your
// option. All files in the project carrying such notice may not be copied,
// modified, or distributed except according to those terms.

use std::cmp::Ordering;
use std::default::Default;
use std::fmt::{self, Debug};
use std::hash::{Hash, Hasher};
use std::num::Wrapping;

use rand::rngs::SmallRng;
use rand::{RngCore, SeedableRng};
use rand_core::impls;

#[cfg(test)]
use rand::Rng;

const N: usize = 624;
const M: usize = 397;
const ONE: Wrapping<u32> = Wrapping(1);
const MATRIX_A: Wrapping<u32> = Wrapping(0x9908b0df);
const UPPER_MASK: Wrapping<u32> = Wrapping(0x80000000);
const LOWER_MASK: Wrapping<u32> = Wrapping(0x7fffffff);

/// The 32-bit flavor of the Mersenne Twister pseudorandom number
/// generator.
#[derive(Copy)]
pub struct MT19937 {
    idx: usize,
    state: [Wrapping<u32>; N],
}

const UNINITIALIZED: MT19937 = MT19937 {
    idx: 0,
    state: [Wrapping(0); N],
};

impl SeedableRng for MT19937 {
    type Seed = [u8; 16];

    #[inline]
    fn from_seed(seed: [u8; 16]) -> MT19937 {
        let mut mt = UNINITIALIZED;
        let mut rng = SmallRng::from_seed(seed);
        mt.idx = N;
        for i in 0..N {
            mt.state[i] = Wrapping(rng.next_u32());
        }
        mt
    }
}

impl RngCore for MT19937 {
    #[inline]
    fn next_u32(&mut self) -> u32 {
        // Failing this check indicates that, somehow, the structure
        // was not initialized.
        debug_assert!(self.idx != 0);
        if self.idx >= N {
            self.fill_next_state();
        }
        let Wrapping(x) = self.state[self.idx];
        self.idx += 1;
        temper(x)
    }

    fn next_u64(&mut self) -> u64 {
        impls::next_u64_via_u32(self)
    }

    fn fill_bytes(&mut self, arr: &mut [u8]) {
        impls::fill_bytes_via_next(self, arr)
    }

    fn try_fill_bytes(&mut self, arr: &mut [u8]) -> std::result::Result<(), rand::Error> {
        self.fill_bytes(arr);
        std::result::Result::Ok(())
    }
}

impl MT19937 {
    /// Create a new Mersenne Twister random number generator using
    /// the default fixed seed.
    #[inline]
    pub fn new_unseeded() -> MT19937 {
        SeedableRng::seed_from_u64(5489u64)
    }

    fn fill_next_state(&mut self) {
        for i in 0..N - M {
            let x = (self.state[i] & UPPER_MASK) | (self.state[i + 1] & LOWER_MASK);
            self.state[i] = self.state[i + M] ^ (x >> 1) ^ ((x & ONE) * MATRIX_A);
        }
        for i in N - M..N - 1 {
            let x = (self.state[i] & UPPER_MASK) | (self.state[i + 1] & LOWER_MASK);
            self.state[i] = self.state[i + M - N] ^ (x >> 1) ^ ((x & ONE) * MATRIX_A);
        }
        let x = (self.state[N - 1] & UPPER_MASK) | (self.state[0] & LOWER_MASK);
        self.state[N - 1] = self.state[M - 1] ^ (x >> 1) ^ ((x & ONE) * MATRIX_A);
        self.idx = 0;
    }

    /// Recover the internal state of a Mersenne Twister instance
    /// from 624 consecutive outputs of the algorithm.
    ///
    /// The returned `MT19937` is guaranteed to identically reproduce
    /// subsequent outputs of the RNG that was sampled.
    ///
    /// Panics if the length of the slice is not exactly 624.
    pub fn recover(samples: &[u32]) -> MT19937 {
        assert!(samples.len() == N);
        let mut mt = UNINITIALIZED;
        for (in_, out) in Iterator::zip(samples.iter(), mt.state.iter_mut()) {
            *out = Wrapping(untemper(*in_));
        }
        mt.idx = N;
        mt
    }
}

#[inline]
fn temper(mut x: u32) -> u32 {
    x ^= x >> 11;
    x ^= (x << 7) & 0x9d2c5680;
    x ^= (x << 15) & 0xefc60000;
    x ^= x >> 18;
    x
}

#[inline]
fn untemper(mut x: u32) -> u32 {
    // reverse "x ^=  x>>18;"
    x ^= x >> 18;

    // reverse "x ^= (x<<15) & 0xefc60000;"
    x ^= (x << 15) & 0x2fc60000;
    x ^= (x << 15) & 0xc0000000;

    // reverse "x ^= (x<< 7) & 0x9d2c5680;"
    x ^= (x << 7) & 0x00001680;
    x ^= (x << 7) & 0x000c4000;
    x ^= (x << 7) & 0x0d200000;
    x ^= (x << 7) & 0x90000000;

    // reverse "x ^=  x>>11;"
    x ^= x >> 11;
    x ^= x >> 22;

    x
}

impl Default for MT19937 {
    #[inline]
    fn default() -> MT19937 {
        MT19937::new_unseeded()
    }
}

#[test]
fn test_32bit_seeded() {
    let mt: MT19937 = SeedableRng::seed_from_u64(0x12345678u64);
    for (&Wrapping(x), &y) in mt.state.iter().zip(STATE_SEEDED_BY_U32.iter()) {
        assert!(x == y);
    }
}

#[test]
fn test_8bit_array_seeded() {
    let mt: MT19937 = SeedableRng::from_seed([
        0x01u8, 0x12u8, 0x23u8, 0x34u8, 0x45u8, 0x56u8, 0x67u8, 0x78u8, 0x89u8, 0x9au8, 0xabu8,
        0xbcu8, 0xcdu8, 0xdeu8, 0xefu8, 0xf0u8,
    ]);
    for (&Wrapping(x), &y) in mt.state.iter().zip(STATE_SEEDED_BY_U8_ARRAY.iter()) {
        assert!(x == y);
    }
}

#[test]
fn test_32bit_output() {
    let mut mt: MT19937 = SeedableRng::seed_from_u64(0x12345678u64);
    for x in TEST_OUTPUT.iter() {
        assert!(mt.next_u32() == *x);
    }
}

#[cfg(test)]
static STATE_SEEDED_BY_U32: [u32; N] = [
    1230984752, 3405803014, 446190936, 356019596, 2612550233, 2220430371, 2341234262, 918708607,
    2028958081, 3694928310, 2494839018, 3334300720, 3204119991, 1117867520, 954926897, 2130266653,
    2400611442, 3034298209, 3316560707, 1192073609, 3695305607, 4135141861, 238924034, 3186168923,
    1940616080, 2891331395, 1778862901, 1934902192, 3580657807, 2145754507, 2001752788, 3749350241,
    604477960, 3235955326, 690504766, 3941619396, 3873149058, 3601222256, 4109152116, 4155587456,
    3303358046, 3509157466, 1016313759, 3831472933, 2844461988, 1303462700, 1845307299, 4171859741,
    2241493636, 2791494503, 154777864, 2339940193, 3703788218, 1081257318, 373877308, 1715958873,
    3389113295, 691874328, 1600481361, 2315839055, 3528854016, 4029393291, 3967723614, 4270684571,
    1769878391, 2228713439, 2121953222, 1146717001, 3587980218, 1757846878, 1929133800, 3321664164,
    3956701388, 4097708122, 70011952, 21772829, 907072767, 1936307393, 2198638448, 4228884740,
    1730490087, 937352433, 3800377805, 1736643578, 2352878692, 2668974205, 1227828772, 2221926085,
    3539556513, 3275560685, 3093472421, 3156824481, 1949623866, 3255304895, 2101628740, 3383632957,
    734920865, 885089999, 4028015294, 3269677580, 2345556633, 1437008949, 2755374037, 1891039879,
    232022343, 2280985422, 1651100549, 2414273722, 3527419016, 2033391142, 2534222734, 146753128,
    4268028694, 924459353, 2034204808, 751189847, 3526079994, 3797103503, 4183898258, 1815537557,
    2970147671, 3492823544, 2152647004, 1708604831, 3135457105, 3669432491, 4231562909, 1587477383,
    36751594, 2995399517, 1652744866, 291312033, 4046710917, 971881225, 596544813, 3345772720,
    19274872, 3906408925, 2587258900, 694883644, 3540992100, 3139566742, 856805294, 363285120,
    1710549761, 3284479289, 2578745821, 849713945, 3969923797, 124579757, 3122156153, 3878393258,
    4134260732, 600647112, 301066463, 2595056827, 1440294899, 3735552904, 3363971916, 299064,
    2197361181, 2392186495, 1712636119, 274299350, 2535037423, 3524714295, 1460253602, 1489797743,
    427870020, 1467968197, 322352092, 887244928, 1210748198, 2848464597, 3752811397, 3820873508,
    3259537058, 2487390235, 336541708, 1572603560, 2479343127, 278085902, 3844219339, 1089325278,
    4232829754, 655025601, 2595157489, 3013838224, 2718860512, 3075169416, 4210880069, 3334084192,
    1730664550, 4093616883, 1866722245, 1592057206, 663292457, 3566931268, 378614409, 2721555443,
    77308528, 1824205239, 757263069, 1715668332, 2689413736, 1502850200, 2388817044, 3949423488,
    656843576, 2116562222, 385663148, 1985096899, 597466618, 4204894400, 268787798, 2441503745,
    3376806632, 3666473993, 1105197302, 1673365119, 610403083, 97760543, 3323432602, 1112592759,
    2037489021, 2453242693, 4200262614, 3930534438, 1491484039, 409345533, 3287654224, 878947091,
    64641498, 1441670926, 490233978, 3917252116, 1738884199, 434229347, 2874234901, 2719023245,
    1912985063, 1994241883, 467159134, 3640750294, 3957478813, 2341802298, 74251713, 2426115049,
    1567252629, 948236730, 3115617770, 2576266638, 1821496232, 2615437734, 267337608, 2800447928,
    1709204873, 3690063243, 3788586988, 2767863135, 3688595100, 1877101211, 3203525119, 1369538658,
    3449783840, 3843313608, 4075238843, 3542900288, 3283241304, 4006895353, 4036336266, 456146737,
    253035582, 4229186324, 913629747, 3564599837, 882817745, 3471754348, 204677012, 1663775497,
    993972994, 3892866693, 3101800280, 4209732746, 2253971895, 1062378653, 2786199606, 3444675052,
    252586191, 365483031, 1425017137, 1767761190, 3784708002, 347639065, 3399869858, 425658383,
    877945846, 2704839615, 1749055959, 2499158793, 3962273623, 256050332, 97743426, 1867901003,
    362698269, 2588932568, 4259594598, 3175399886, 912251217, 1190886720, 187178845, 953218059,
    2180849408, 1768303843, 3762089793, 122772153, 3982668773, 1282999811, 1656874608, 3959355886,
    1994871220, 3558352502, 3403184052, 456966757, 3081006156, 276983076, 342291224, 1922465957,
    4162958369, 3227489136, 4184607785, 1681506689, 833659284, 2693487294, 3652073907, 2324429904,
    2121921024, 4284412295, 827750055, 4098858265, 2103611779, 3834960160, 1965765311, 2546387496,
    2732069970, 540550183, 2118915638, 3545969075, 3977585511, 3950750202, 180626933, 1534093895,
    1332954077, 1621895884, 456821892, 499773592, 2706616269, 1728386750, 796237554, 2331567114,
    1662260048, 1531529664, 2117005560, 2153629292, 2786915986, 1530037747, 4185023400, 4019209005,
    1190074777, 4211269436, 1256325471, 1983846707, 985395686, 3815839116, 3786657936, 3058663318,
    1759169642, 1315772593, 769805651, 1350275660, 3703583393, 788808979, 3861519472, 3471348442,
    839789396, 2762564167, 4149526653, 2312084189, 509556838, 1046299261, 3589380836, 3455217789,
    4020081196, 3479117263, 276758140, 1872028702, 1857271987, 256102798, 922154212, 3358943127,
    1963405439, 2683428084, 3270721307, 2707325535, 1068988007, 3377145524, 551849831, 285872621,
    3280884050, 3412406936, 870340699, 2439072487, 1776681294, 1512244983, 3148196792, 2127674330,
    992630581, 3818290270, 917351442, 2527937621, 3120467395, 4194523968, 495207936, 3090076354,
    3348598156, 4201110522, 1388035808, 1367309275, 4199499478, 628883188, 1669521471, 1951999659,
    1464541558, 2670208312, 1488582941, 1524703372, 3648831290, 1269146375, 2769573741, 2118096175,
    1455540810, 2973355889, 1252210633, 3689264801, 3768873757, 2064160631, 56054369, 3455435251,
    3182056459, 1149406637, 487205374, 3174119682, 2214037074, 1455765568, 2870304290, 2616817658,
    2679375226, 972197765, 120263160, 1173131240, 2370184594, 1834980939, 3002104565, 2730780473,
    2195797878, 3175335063, 1049328627, 30076862, 1278600208, 330089038, 2008323280, 3300937371,
    3899163477, 4011459395, 308943269, 2112977701, 3585537206, 2466694551, 717864249, 2813331203,
    2259690467, 4106955171, 2712557103, 2140366906, 769826025, 3675158511, 4159580068, 2809189023,
    839529485, 2237766189, 411962550, 533783899, 3261368448, 862646336, 275115949, 4188109060,
    4135399494, 1256169959, 3139630802, 3374352336, 1643234136, 2778871580, 2688064789, 3876401084,
    3343426537, 2190931822, 3725412271, 819184474, 3941215748, 4198059840, 2242058691, 4073695980,
    966672187, 2490326002, 344331811, 2962086358, 3597509685, 3857765994, 3066159215, 4258789794,
    313396156, 2709322320, 2259066721, 1133502972, 2060209141, 881037131, 236156334, 886643174,
    3527565891, 2674863663, 512667884, 2887610211, 4203456857, 2536498262, 804141461, 1184532939,
    4004922895, 2994384314, 757417810, 3233621454, 2185091223, 1112840015, 2757190375, 534207746,
    4141891764, 667513258, 4112811347, 1298208905, 4275176604, 3469693149, 2055586776, 3254428667,
    2130972935, 2809701806, 3451354140, 3950644476, 2028441660, 2540800252, 2776421712, 610448315,
    2356401764, 3534652897, 931003641, 3991282150, 96284197, 1026293884, 4101207574, 3155660301,
    2025171783, 2676510845, 387248950, 2859447460, 4146107629, 1178787167, 3325601350, 859603407,
    3898115054, 3221250970, 3563820913, 2256000595, 4138935717, 502453040, 311383703, 2896802815,
    775149563, 2824009485, 3475724737, 3202719549, 781758877, 216584329, 917768536, 1818106958,
    1735772449, 1848295164, 91013851, 3827689061, 1869485563, 1546534068, 1088129966, 4212643054,
    3379361706, 2832713118, 1302090334, 3220157665, 4294326951, 4050945699, 2709838841, 2270965558,
    672700265, 1783062535, 2931042457, 4086473130, 4107301934, 2075815682, 3160182337, 2785307388,
    1693270391, 2152225462, 193714890, 268601059, 3046336591, 2509102758, 3810755835, 1034463279,
];

#[cfg(test)]
static STATE_SEEDED_BY_U8_ARRAY: [u32; N] = [
    2125812116, 3267037162, 2281526237, 528186713, 1124277940, 4258453061, 2355537702, 1359987462,
    3492373519, 499151658, 2374188768, 2404842357, 4262096690, 1692956193, 1130677545, 3469541423,
    1110365694, 105067549, 3653547306, 3250812317, 4050717184, 356575339, 1397060734, 3756914195,
    1400426057, 2862907582, 3700530865, 2474685019, 4099335889, 4080058033, 3641486299, 1877998626,
    1805941339, 2819172942, 2453171918, 1624136720, 3174032212, 63649791, 1814904174, 1137470325,
    3758391740, 3794693926, 4008783655, 3834145485, 3665006289, 2014112211, 577693474, 873511070,
    392959976, 3058153158, 492936032, 1107900944, 4220494682, 2490892504, 2086777089, 2156511224,
    856991345, 3289821763, 834447717, 4129377147, 1293982632, 2204323535, 336111202, 2473758760,
    3743850612, 4176405450, 2455426246, 1652891124, 3787312819, 1583972605, 484665183, 420166691,
    2489614881, 1279026283, 2398382977, 2721988409, 3433883762, 2795030108, 2900142713, 1009685840,
    2231748506, 4062524015, 2458720129, 3368800328, 3763009440, 1864506468, 1452847722, 1316013192,
    4269374655, 1497681658, 959030151, 742045052, 4100717158, 3219579122, 422563374, 3258391901,
    3413593304, 3660072304, 440783311, 3238097971, 4045471250, 680444676, 1013162536, 686870539,
    2779080728, 603841652, 4142133739, 3672779658, 3109136593, 2347963123, 247618828, 2034399842,
    3002755503, 196634655, 3327154628, 3885996943, 3239860661, 397072753, 975444279, 3957055434,
    2434022487, 3928568980, 1328456362, 1022310493, 2731505450, 2862237891, 2014513003, 1141080996,
    1116254449, 867062876, 1740458191, 477785495, 49736024, 4264244212, 297346883, 795538782,
    1562645645, 1841718819, 728788241, 3990176739, 1853138701, 360943929, 3258291752, 3150115283,
    2878609156, 2128255719, 4152055715, 1408519854, 2988609059, 60022166, 591844434, 4072122131,
    68009781, 1119569962, 3563706382, 2661665068, 4220868422, 3615692990, 1134048952, 1084411164,
    2888953638, 2402483324, 3591327012, 3141526549, 807169504, 883346138, 2616244632, 3860338831,
    2120533777, 2000995852, 1454974431, 2976573152, 2521176984, 2968882553, 3264503509, 2738678224,
    1796051146, 1456656689, 1880650888, 3011657357, 3887034030, 1893793200, 2535272183, 2615546516,
    3927543761, 532315247, 2127620717, 4196123540, 2206445877, 3600116091, 620055440, 1690294751,
    2670219104, 2417279603, 1005767767, 1942324004, 1767608639, 431560808, 4063929856, 4230230157,
    3106143893, 1323778920, 1138044554, 867438150, 4160410794, 3342881221, 667569444, 1862647918,
    22867611, 4092827775, 2909949709, 416466315, 4057396003, 3326888804, 3738705656, 882488178,
    94917211, 2343933570, 3214240228, 3854491359, 1695165226, 2987922475, 3866707199, 1794661418,
    2364356015, 186170369, 3812646107, 831657129, 3967261398, 1729265884, 1028984276, 1343412875,
    3885700420, 3656598809, 34481886, 4074106620, 636638474, 377701592, 3686867598, 3637479667,
    3009266260, 1172091740, 3446174132, 1988721619, 2363079728, 702071073, 905645781, 2635960856,
    986814943, 266857114, 2796166958, 2484477390, 609909256, 2823052463, 3047621525, 1827759238,
    2711374281, 1017556423, 1625702846, 2801017174, 126942933, 3533423313, 730622110, 3984228439,
    1184583664, 634103762, 3361864592, 4132306885, 1102666785, 3387895155, 1982277802, 2978524953,
    1203402916, 2042583996, 4199256095, 1510656833, 1012664225, 900012657, 3761341377, 3843985833,
    1211385738, 2143332521, 1901568159, 3488067282, 113107193, 1052895673, 707256721, 148094221,
    2619730374, 617790799, 2557861132, 3098389994, 1936993226, 3454504318, 2449633607, 1369748188,
    34368047, 2503462957, 2286545654, 557997205, 3427199697, 4151941788, 72699622, 3527511295,
    1835415071, 350117680, 2435703993, 3617701351, 84499344, 280218401, 3472474380, 1680684701,
    2020057772, 2262428657, 1091100664, 3100771051, 4011956095, 41890960, 3620849044, 2842733451,
    1021051972, 680555062, 4046574674, 2465345048, 1815907291, 2228054015, 1638840780, 14600989,
    1902414539, 1424378185, 4028157243, 3490707781, 4186115510, 3052579007, 1267530105, 3695208168,
    3111120769, 2686073155, 3827951418, 1569550743, 2694082139, 2381733750, 3781644357, 4187860471,
    4028571123, 1806825182, 3390507012, 3808685696, 888544043, 85995051, 2477174981, 2395691810,
    1103536037, 3978950882, 3984908897, 3447906265, 1182361160, 3770524707, 39995121, 994429113,
    178720377, 2190207457, 4015272625, 3712754008, 2524570178, 616770692, 574610203, 3660281210,
    1174602218, 151428720, 1281802873, 626711461, 1336765556, 742603112, 2049905359, 3338272833,
    879487316, 824129964, 1730657833, 2207129415, 3348820311, 3217798010, 2579338803, 4139363834,
    2078813206, 65871291, 3050804923, 1446341734, 2145889826, 4222906688, 1345255710, 1781343139,
    4094930446, 2888206061, 2985391609, 3414409980, 2429698445, 3495578346, 261494072, 2333176051,
    2812580030, 2704971478, 1849718488, 750092181, 3608001622, 954438415, 1895873046, 3263070899,
    1602640384, 885416565, 2674001318, 699040853, 4158129633, 880983093, 2499262691, 1822076464,
    1487881200, 2411715641, 167550360, 290604720, 3468433878, 2385670958, 2016996442, 1284719170,
    3518801459, 3411616661, 1620398750, 4283547607, 3553908077, 1833953995, 3185731527, 1806696757,
    1543165357, 3111357382, 2369580741, 3575536535, 1460971242, 1571735658, 1462132876, 917848020,
    2738534116, 1905919295, 1894247769, 3893175711, 2068835058, 1018575508, 3515817551, 117755560,
    2960504369, 1905778338, 3022945913, 2246440319, 3264395495, 2424133458, 4029419066, 435472744,
    4004950235, 2007137968, 2103307784, 3902368155, 546865731, 2873037912, 2175822601, 1128865654,
    3293801160, 1240505853, 3131590363, 677488585, 1376285871, 1006560226, 3236046869, 2013696124,
    2505772005, 2018453320, 2026042075, 1720020767, 3999433491, 1689537168, 1236328992, 1621591760,
    1531348553, 1677518496, 1869498309, 1125998325, 2017596784, 705602069, 354453807, 4186061695,
    1354496270, 3380702004, 1428879222, 2929176781, 995367972, 3313198444, 4287095953, 2596232739,
    498705578, 379208943, 1403288491, 944424106, 3853363876, 1755193342, 1416772423, 1403804385,
    2239996954, 3995356793, 17845467, 2482278428, 1686331504, 995470490, 2352011730, 3369649670,
    837205195, 2947108651, 1878139589, 12866032, 4166356146, 3780191725, 4257139365, 15960353,
    1205298595, 3713601060, 2288623610, 743110284, 3819169779, 4214373399, 938331797, 1650585946,
    1202513804, 308628676, 3635894297, 508532967, 48300530, 4216414152, 4168475710, 3986369276,
    1186177039, 392899137, 1225690025, 271277434, 2958310143, 387131566, 2759128195, 557004000,
    1161094778, 570692477, 2467031303, 3775664568, 1989960286, 2165268914, 1650315117, 1092609116,
    2483172050, 616870048, 2336325797, 922203220, 660691390, 4034724171, 3588280430, 2130528390,
    161320252, 2763965615, 1184710186, 3634830759, 1905195252, 1545602790, 77360752, 4257113049,
    3420927357, 801965688, 2329027857, 907409426, 1856500813, 1889219480, 3759882779, 3272569543,
    359288556, 729724588, 1132561855, 4113809829, 2516047714, 1934074404, 3515460178, 1656512654,
    3313902888, 2817267292, 1524863785, 4113322555, 2199571535, 2214570842, 523734322, 2511059806,
    823616718, 2830562654, 1397555373, 4269138818, 903048008, 2895336283, 1700775907, 196963164,
    1699963231, 2498025242, 1039571287, 2806268936, 379025035, 3918305231, 1739289266, 2474450171,
    1087187934, 2127021966, 2316738082, 1683919731, 3837374658, 2278474143, 2821539361, 1937110015,
    100325466, 1163278469, 4010583202, 917694259, 3343547641, 753253738, 3585023570, 577435200,
];

#[cfg(test)]
static TEST_OUTPUT: [u32; 1000] = [
    1288371523, 661758031, 1391789126, 2235818537, 3350400874, 3523321489, 2132622744, 488190641,
    2942415761, 2983438516, 331283726, 297350859, 3649892681, 1468530128, 1402597371, 860665474,
    2998365048, 1552948394, 758076402, 1147114492, 3079168988, 1738214811, 272569479, 1526542674,
    3255202977, 4088858818, 1232507865, 2203044968, 462697137, 2228404428, 1820081786, 1696177029,
    625173480, 2505331117, 2078892818, 969029530, 736204184, 3429090378, 2054525030, 3082366143,
    341670814, 3879013143, 1957452887, 96472801, 2713190055, 2802287908, 1291470326, 922688713,
    2349030194, 1277765278, 2064334970, 2476061772, 2530835283, 1155832978, 3660756155, 2277263743,
    3862940470, 3842949245, 328408144, 1030592705, 2749157013, 3707524832, 2069544316, 2499278202,
    3762960122, 83534593, 233253177, 2744649128, 2558106807, 1488820356, 3507806269, 2139073266,
    2560024127, 2246205926, 1258495574, 3677058100, 476285609, 2787919901, 4200529893, 23295704,
    52635483, 1735901230, 1651334868, 447817880, 2204322492, 4148386133, 3015480045, 4190592711,
    2740326682, 3579701766, 293914600, 3837622327, 3916347475, 822387280, 605757300, 1697309730,
    4177436569, 4255227597, 2128859552, 3967517854, 3520845766, 3824922475, 437538848, 3112872238,
    2745305924, 2284431899, 3670433947, 911549870, 2564610981, 4231093278, 896183480, 333753084,
    3805386266, 3221342236, 573029777, 3571815811, 2565852959, 2570845813, 858908108, 191730101,
    2518231566, 3331615028, 230295110, 2111949136, 1820682243, 4204016280, 1532285360, 1563508937,
    3663123434, 1065334752, 4096374151, 2075465303, 1544814681, 2068960985, 1408939567, 1433395626,
    3733320797, 3658710843, 2349807414, 3546887259, 2616712390, 3882556523, 919979755, 2760776072,
    734373931, 1049213894, 389842618, 781834170, 1680212956, 3223476283, 2159374059, 2417835417,
    33171455, 965256122, 3810557861, 1521986058, 2147215360, 2550753269, 2427280323, 172489993,
    3046166018, 978450096, 3393975427, 114827663, 2989172100, 200851186, 3089231132, 3210370040,
    1235399753, 2264524227, 3189116189, 3338865801, 1134866748, 2189293001, 1159997015, 2581081041,
    3883525559, 4271952015, 552170097, 127715239, 3896435370, 69193354, 20051542, 144934985,
    2203027646, 2380281179, 17746682, 1238853100, 3425256616, 4009134258, 3462731270, 2452527822,
    2181453528, 3722722997, 3538433857, 2030180117, 2976107617, 1781813968, 3518723453, 3053590971,
    3905752416, 2153350208, 1430717891, 3539022831, 2366550867, 2116843186, 1197542393, 4136802354,
    1968657267, 2005642522, 809320118, 1396175106, 1551440268, 3704515026, 3459341149, 3248796642,
    4027441566, 2878000310, 3845520530, 3335351168, 2353669842, 2403560532, 2069168665, 2318350023,
    752042458, 961771674, 1267087035, 2741752642, 2882967600, 2921569026, 1567015514, 3637648890,
    3457533553, 3055859949, 2143928007, 3410277686, 4221243203, 1648962469, 2125355793, 343182288,
    3295914002, 754728201, 2429263903, 1154696131, 3013365925, 2345435564, 3588400151, 1942042475,
    3014821891, 3310136038, 2031480196, 2537817528, 2202197226, 980155561, 3897824325, 2358898425,
    1326984748, 1704520806, 2069306963, 4087808040, 1725200365, 2726939490, 3128416734, 2942499408,
    3180330641, 13678888, 4104942367, 1346384145, 2510427202, 3989813267, 3670410354, 164864369,
    1584143792, 4212566419, 2554203337, 47774158, 370866376, 3107612813, 425196034, 1634699986,
    3854275656, 417563448, 1137324049, 3225813044, 2448794093, 763126352, 1849935717, 1558610455,
    2462377121, 877687919, 2495190180, 1938512955, 1069447069, 2929401833, 555987768, 394173771,
    2543461970, 703063460, 2432452797, 2964355683, 4133821817, 3200828722, 2362745209, 3994436886,
    375798940, 1586330278, 2881928282, 1935042010, 837027357, 1420045696, 81856847, 3604336384,
    2703825173, 1344085282, 3130541968, 2549482018, 1473911807, 3612097404, 2933960120, 1177813930,
    2619445024, 2570428642, 2638515086, 3305884804, 2544363768, 1247654892, 2164275123, 3023259518,
    1958495867, 1836075620, 2122967291, 865936523, 1906992529, 210702970, 2100437856, 3538260276,
    3834385492, 2371578825, 2333458812, 447788963, 3620449971, 3855140047, 1217380321, 1900906207,
    372398575, 1508922534, 80936569, 371904298, 2328173543, 1175399258, 4203326822, 2697174145,
    3825891483, 2586066950, 3788770211, 3809250345, 2790878375, 2073935434, 2925640233, 2342017491,
    1207622535, 2313575099, 153437266, 567251721, 2310541257, 3337737083, 2538891407, 1904068496,
    474066322, 3577594711, 2158050978, 2436223963, 4256789597, 2382446848, 2266968295, 3336930421,
    2275914394, 3204123196, 3758598528, 736112099, 1589246834, 3709032496, 3406658432, 2860248104,
    962999250, 118992406, 747975395, 1734001520, 3348040804, 1073368836, 1734217534, 1860527352,
    2942450571, 3845898763, 1230171579, 2397206450, 3037766083, 815807789, 998543612, 2761790455,
    2421093026, 2710056075, 2898322841, 4011618467, 1673897022, 2628162896, 4240520942, 3287547413,
    4167292938, 3092319087, 642774876, 96236869, 3567768456, 305783729, 117052625, 3789690156,
    3669985000, 4147438593, 562888081, 1452108602, 40650306, 1972234204, 737455652, 3077448796,
    2397855846, 2026368873, 976175587, 1701539606, 786974121, 3077812406, 3379000324, 1456104747,
    446663040, 1984931178, 3454642872, 2714414082, 1717719920, 3708746432, 1429346980, 702323036,
    3572258999, 1886507731, 723533185, 1498048975, 1211812385, 1078435394, 623569685, 1634429043,
    3151752389, 347593532, 508566602, 441233580, 659857384, 3556773150, 4271559764, 2863609619,
    1395588578, 949561320, 3836354008, 278029307, 2186819687, 2271957339, 3715317288, 1177534854,
    3577673670, 1943658059, 2843074401, 3873936353, 730018749, 2816380027, 2948645767, 1334930893,
    1806736507, 4077732374, 780916085, 2649665696, 4152062725, 1871072750, 4213568488, 3014209514,
    3489324135, 3939934302, 1589609435, 1966236466, 1913239515, 2987086132, 3364799977, 1615055652,
    140814623, 2654538486, 630772356, 647872093, 3226239232, 3521387148, 3348459761, 2977936005,
    1272134996, 737342329, 564603532, 1895217318, 1801689763, 425440346, 2515942665, 379789009,
    4061490334, 2888515991, 1848190226, 2902749127, 1743948488, 955018561, 1657050904, 2074140239,
    1491636793, 4131284803, 2944485624, 1881210257, 1604996777, 1611527273, 917060317, 4150426772,
    2919311272, 2976588602, 395400560, 200166200, 2830162341, 2518237924, 1467978482, 3122449577,
    2604870268, 764706612, 552060676, 1066769855, 4178678036, 1976084537, 2940906585, 2554995164,
    3044570624, 1574385791, 3191955088, 3511573971, 1389293617, 2840354985, 1241396308, 1368347188,
    1937954317, 3270124434, 4000424999, 1525499901, 367875718, 3907882836, 2701347864, 1590802222,
    3307582447, 1177778054, 3008278911, 1050804251, 977534670, 871617600, 620739052, 4006701248,
    811770896, 2895387491, 993273169, 396980500, 1503713801, 3372301253, 2988529840, 3626070649,
    1454815586, 659222212, 2018553009, 2574287241, 4111392850, 2311502101, 2613468343, 3263814411,
    143609265, 887277108, 1130495860, 2888242745, 2933827853, 4257418321, 38232150, 580505630,
    1091161999, 352394605, 401918150, 652322125, 134303170, 312376144, 3338675068, 2992439733,
    2540451913, 1375595341, 4134573174, 3829775558, 3053933472, 1537922703, 118597976, 3768818177,
    1170492610, 2729549158, 2676107118, 4158949875, 2293596799, 1223717829, 3659691850, 2605368314,
    99335602, 3261617566, 1562373774, 4188632305, 3162709588, 862664381, 2432614305, 989994721,
    136064291, 780078254, 3147219764, 685449917, 1111104069, 2721116399, 3349706932, 1783367717,
    3361116953, 637916776, 194520522, 2892252011, 1203692622, 1770825068, 2448795682, 282104278,
    2295816748, 756282211, 352738234, 1692259376, 2403131116, 832858728, 1890833447, 2722183323,
    3356143994, 793013227, 2979663310, 3987961085, 2012980741, 129272082, 1699051575, 4042739956,
    4195394213, 1860083372, 757069917, 36392061, 3475164780, 1023421402, 1302836356, 1517819032,
    737513963, 2083408619, 273073588, 1984234758, 2317213726, 3180686618, 2828898294, 4051618227,
    3229582648, 3581495048, 3423789991, 1953005114, 2347693647, 1358247952, 1164930740, 796046883,
    2800848236, 3691599361, 3098123799, 730627810, 2441606245, 1227599878, 2445050392, 1490515220,
    636474675, 551830161, 1380296292, 4180634010, 470130345, 4040630674, 352369532, 1146151896,
    3672849124, 1325571988, 255279534, 3607634527, 811258999, 533431538, 2816553078, 1084327089,
    3066727921, 3652615633, 1400251202, 461838, 937554735, 3267823382, 3354869094, 201759443,
    652472206, 1079136210, 3446243081, 1306022109, 1934745716, 4053541595, 1413281450, 2218903406,
    2350125074, 3764186713, 571031354, 1357130610, 210066705, 2136560525, 2553111052, 3588406584,
    1429578282, 1046130062, 1413996866, 2579141654, 3256193731, 2845584016, 3281684187, 2073834243,
    410080344, 3336232734, 1849716093, 4204962227, 2825893263, 2488022010, 3327317529, 576630845,
    978076078, 3748865785, 495860505, 941897624, 776311168, 2981375676, 4116748735, 580695584,
    2112228946, 1375496604, 4131211934, 2702431613, 154543731, 2433904162, 55550866, 2776552873,
    4005984325, 1173849631, 381177693, 2639033681, 2860535550, 3070325404, 4264140449, 13231829,
    1117886901, 2454704395, 2302767319, 1241140660, 978397775, 3394565050, 434732911, 2172133681,
    875136194, 2546657898, 778793866, 2745773924, 993854782, 2789744842, 2778501486, 2167403903,
    70751886, 2500710052, 3588134711, 3474274076, 3829572129, 473062740, 2090360336, 3539659987,
    1675638102, 3246278596, 1923183488, 891532558, 826499856, 3574708818, 4182420594, 2304131117,
    1163446189, 151099005, 1563606489, 1147779199, 933134483, 848289801, 4043298041, 906482605,
    1241356104, 1902591667, 3665276436, 3231502318, 1877058363, 2660054914, 667208113, 3293940624,
    795024168, 1002558050, 3293692777, 1944765743, 3700102984, 540329840, 1799739462, 1662094627,
    734582186, 4220494891, 2705552536, 108642384, 2078863526, 2499190231, 2383365568, 1966443525,
    3044868056, 2890280772, 4086262179, 2162635138, 1721889982, 2478789752, 1223115825, 885851122,
    2554230467, 3659063896, 3523768973, 339136325, 4139085721, 61246529, 3979571410, 1493522930,
    1980973513, 2352549823, 649940254, 1619084772, 2800368896, 3079711258, 558218236, 4096228988,
    1769490650, 615466712, 4226310345, 3768779855, 3562784627, 1120091613, 1583468228, 2099689563,
    2612496976, 3559130252, 548164275, 1337688677, 543818854, 304251367, 602706906, 3756410845,
    3288372435, 2909210628, 541751787, 1057584978, 450839266, 2795125113, 976588817, 1038352180,
    2165680160, 1054852977, 692408044, 1900540653, 2131185411, 3476276222, 2528055098, 2664741988,
    4159972327, 4126489427, 1335249546, 529121240, 838143284, 2862440547, 1450968524, 3280057161,
    31087495, 978015248, 625905279, 1668218345, 2695435909, 1544428360, 1211679212, 2401046511,
    77280032, 528702700, 2317402059, 1670399578, 3395575867, 2323287041, 623665415, 3022960469,
    2405815900, 1244031238, 1634028074, 2382452992, 663667525, 1056657009, 3642931143, 1825321946,
    1982764312, 2559833364, 808012522, 1802888051, 3875654458, 111089461, 2764014257, 867527967,
    3097956231, 2338519262, 4247741564, 247991169, 2739921766, 933412632, 23454358, 1020680553,
    394978695, 2823008343, 1694042338, 3759325696, 3451235830, 3973651415, 950910362, 2114968325,
    1031928846, 2293788121, 1472749802, 2348606437, 177330813, 3687749378, 2285431007, 2988997607,
    562728622, 3586142936, 1454117512, 3897036733, 3909104677, 2862844354, 3974297008, 3167428759,
    1118806409, 896393667, 3720757994, 1053157505, 3567186474, 651017473, 2236545159, 4169059056,
    3323889377, 1808548066, 4276120348, 3599503927, 2441610969, 253467101, 1057361759, 3163988933,
    3256887220, 2940032135, 1745086935, 214162224, 2680292982, 167188679, 90308400, 3733944081,
    275873021, 3604019870, 2084000839, 2616110039, 540558970, 1561529446, 2777623483, 2101671738,
    2676990231, 2523452981, 2847956394, 2173248293, 1542575758, 2847738565, 2283258344, 2210145468,
    989212830, 3485721888, 1580752355, 968576767, 2726142734, 242006811, 1724560858, 3918352802,
];

#[test]
fn test_untemper() {
    let mut rng: SmallRng = rand::SeedableRng::seed_from_u64(1234);
    let x = rng.next_u32();
    assert_eq!(x, untemper(temper(x)));
}

#[test]
fn test_recovery() {
    let seed = ::rand::thread_rng().gen::<u64>();
    let mut orig_mt: MT19937 = SeedableRng::seed_from_u64(seed);
    // skip some samples so the RNG is in an intermediate state
    let to_skip = ::rand::thread_rng().gen_range(1, N);
    for _ in 0..to_skip {
        orig_mt.next_u64();
    }
    let samples: Vec<u32> = (0..N).map(|_| orig_mt.next_u32()).collect();

    let mut recovered_mt = MT19937::recover(&samples[..]);
    for _ in 0..N * 2 {
        assert!(orig_mt.next_u32() == recovered_mt.next_u32());
    }
}

// Note: At the time I'm writing this, the `derive` attribute does not
// work for large-ish arrays, so these traits below that are usually
// derived must be manually implemented.

impl Clone for MT19937 {
    #[inline(always)]
    fn clone(&self) -> MT19937 {
        *self
    }
}

impl Debug for MT19937 {
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
        f.debug_struct("MT19937")
            .field("idx", &self.idx)
            .field("state", &&self.state[..])
            .finish()
    }
}

impl Eq for MT19937 {}

impl Hash for MT19937 {
    fn hash<H: Hasher>(&self, hasher_state: &mut H) {
        self.idx.hash(hasher_state);
        for x in self.state.iter() {
            x.0.hash(hasher_state)
        }
    }
}

impl Ord for MT19937 {
    fn cmp(&self, other: &MT19937) -> Ordering {
        match Ord::cmp(&self.idx, &other.idx) {
            Ordering::Equal => Ord::cmp(&self.state[..], &other.state[..]),
            ordering => ordering,
        }
    }
}

impl PartialEq for MT19937 {
    fn eq(&self, other: &MT19937) -> bool {
        self.idx == other.idx
            && Iterator::zip(self.state.iter(), other.state.iter()).all(|(l, r)| l == r)
    }
}

impl PartialOrd for MT19937 {
    fn partial_cmp(&self, other: &MT19937) -> Option<Ordering> {
        Some(Ord::cmp(self, other))
    }
}
