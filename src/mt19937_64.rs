// src/mt19937_64.rs
//
// Copyright (c) 2015,2017 rust-mersenne-twister developers
//
// Licensed under the Apache License, Version 2.0
// <LICENSE-APACHE or http://www.apache.org/licenses/LICENSE-2.0> or the MIT
// license <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your
// option. All files in the project carrying such notice may not be copied,
// modified, or distributed except according to those terms.

use std::cmp::Ordering;
use std::default::Default;
use std::fmt::{self, Debug};
use std::hash::{Hash, Hasher};
use std::num::Wrapping;

use rand::rngs::SmallRng;
use rand::{RngCore, SeedableRng};
use rand_core::impls;

#[cfg(test)]
use rand::Rng;

const NN: usize = 312;
const MM: usize = 156;
const ONE: Wrapping<u64> = Wrapping(1);
const MATRIX_A: Wrapping<u64> = Wrapping(0xB5026F5AA96619E9);
const UM: Wrapping<u64> = Wrapping(0xFFFFFFFF80000000); // Most significant 33 bits
const LM: Wrapping<u64> = Wrapping(0x7FFFFFFF); // Least significant 31 bits

/// The 64-bit flavor of the Mersenne Twister pseudorandom number
/// generator.
#[allow(non_camel_case_types)]
#[derive(Copy)]
pub struct MT19937_64 {
    idx: usize,
    state: [Wrapping<u64>; NN],
}

const UNINITIALIZED: MT19937_64 = MT19937_64 {
    idx: 0,
    state: [Wrapping(0); NN],
};

impl SeedableRng for MT19937_64 {
    type Seed = [u8; 16];

    #[inline]
    fn from_seed(seed: [u8; 16]) -> MT19937_64 {
        let mut mt = UNINITIALIZED;
        let mut rng = SmallRng::from_seed(seed);
        mt.idx = NN;
        for i in 0..NN {
            mt.state[i] = Wrapping(rng.next_u64());
        }
        mt
    }
}

impl RngCore for MT19937_64 {
    #[inline]
    fn next_u32(&mut self) -> u32 {
        self.next_u64() as u32
    }

    #[inline]
    fn next_u64(&mut self) -> u64 {
        // Failing this check indicates that, somehow, the structure
        // was not initialized.
        debug_assert!(self.idx != 0);
        if self.idx >= NN {
            self.fill_next_state();
        }
        let Wrapping(x) = self.state[self.idx];
        self.idx += 1;
        temper(x)
    }

    fn fill_bytes(&mut self, arr: &mut [u8]) {
        impls::fill_bytes_via_next(self, arr)
    }

    fn try_fill_bytes(&mut self, arr: &mut [u8]) -> std::result::Result<(), rand::Error> {
        self.fill_bytes(arr);
        std::result::Result::Ok(())
    }
}

impl MT19937_64 {
    /// Create a new Mersenne Twister random number generator using
    /// the default fixed seed.
    #[inline]
    pub fn new_unseeded() -> MT19937_64 {
        let mut mt = UNINITIALIZED;
        mt.reseed(5489u64);
        mt
    }

    fn reseed(&mut self, seed: u64) {
        self.idx = NN;
        let mut rng = SmallRng::seed_from_u64(seed);
        for i in 0..NN {
            self.state[i] = Wrapping(rng.next_u64());
        }
    }

    fn fill_next_state(&mut self) {
        for i in 0..NN - MM {
            let x = (self.state[i] & UM) | (self.state[i + 1] & LM);
            self.state[i] = self.state[i + MM] ^ (x >> 1) ^ ((x & ONE) * MATRIX_A);
        }
        for i in NN - MM..NN - 1 {
            let x = (self.state[i] & UM) | (self.state[i + 1] & LM);
            self.state[i] = self.state[i + MM - NN] ^ (x >> 1) ^ ((x & ONE) * MATRIX_A);
        }
        let x = (self.state[NN - 1] & UM) | (self.state[0] & LM);
        self.state[NN - 1] = self.state[MM - 1] ^ (x >> 1) ^ ((x & ONE) * MATRIX_A);
        self.idx = 0;
    }

    /// Recover the internal state of a Mersenne Twister instance
    /// from 312 consecutive outputs of the algorithm.
    ///
    /// The returned `MT19937_64` is guaranteed to identically
    /// reproduce subsequent outputs of the RNG that was sampled.
    ///
    /// Panics if the length of the slice is not exactly 312.
    pub fn recover(samples: &[u64]) -> MT19937_64 {
        assert!(samples.len() == NN);
        let mut mt = UNINITIALIZED;
        for (in_, out) in Iterator::zip(samples.iter(), mt.state.iter_mut()) {
            *out = Wrapping(untemper(*in_));
        }
        mt.idx = NN;
        mt
    }
}

#[inline]
fn temper(mut x: u64) -> u64 {
    x ^= (x >> 29) & 0x5555555555555555;
    x ^= (x << 17) & 0x71D67FFFEDA60000;
    x ^= (x << 37) & 0xFFF7EEE000000000;
    x ^= x >> 43;
    x
}

#[inline]
fn untemper(mut x: u64) -> u64 {
    // reverse "x ^=  x >> 43;"
    x ^= x >> 43;

    // reverse "x ^= (x << 37) & 0xFFF7EEE000000000;"
    x ^= (x << 37) & 0xFFF7EEE000000000;

    // reverse "x ^= (x << 17) & 0x71D67FFFEDA60000;"
    x ^= (x << 17) & 0x00000003eda60000;
    x ^= (x << 17) & 0x00067ffc00000000;
    x ^= (x << 17) & 0x71d0000000000000;

    // reverse "x ^= (x >> 29) & 0x5555555555555555;"
    x ^= (x >> 29) & 0x0000000555555540;
    x ^= (x >> 29) & 0x0000000000000015;

    x
}

impl Default for MT19937_64 {
    #[inline]
    fn default() -> MT19937_64 {
        MT19937_64::new_unseeded()
    }
}

#[test]
fn test_64bit_seeded() {
    let mt: MT19937_64 = SeedableRng::seed_from_u64(0x123456789abcdefu64);
    for (&Wrapping(x), &y) in mt.state.iter().zip(STATE_SEEDED_BY_U64.iter()) {
        assert!(x == y);
    }
}

#[test]
fn test_8bit_slice_seeded() {
    let mt: MT19937_64 = SeedableRng::from_seed([
        0x01u8, 0x12u8, 0x23u8, 0x34u8, 0x45u8, 0x56u8, 0x67u8, 0x78u8, 0x89u8, 0x9au8, 0xabu8,
        0xbcu8, 0xcdu8, 0xdeu8, 0xefu8, 0xf0u8,
    ]);
    for (&Wrapping(x), &y) in mt.state.iter().zip(STATE_SEEDED_BY_U8_ARRAY.iter()) {
        assert!(x == y);
    }
}

#[test]
fn test_64bit_output() {
    let mut mt: MT19937_64 = SeedableRng::seed_from_u64(0x123456789abcdefu64);
    for x in TEST_OUTPUT.iter() {
        assert!(mt.next_u64() == *x);
    }
}

#[cfg(test)]
static STATE_SEEDED_BY_U64: [u64; NN] = [
    372976667190672080,
    8955767531554494093,
    10735884304694020686,
    18318043692813108954,
    14719972226660941534,
    13251776625116254949,
    11992131624488644418,
    16659711168915080089,
    1164579424039144160,
    10468418260030677995,
    17451476771648127725,
    6754649079880715154,
    4332453159850645646,
    13810716746798917818,
    4233521230021447529,
    15798279944273013365,
    2600660138463903136,
    16759719554284343760,
    14224540094577815649,
    1211404970948399381,
    2513311753238405253,
    9258930104506130559,
    2849701765146263059,
    15554956742359939027,
    8020484588256713044,
    3167814637910610259,
    9374665125369232881,
    17321563897714060884,
    7785695436969576697,
    16819004766652592545,
    15098696822732848113,
    13196308407892940327,
    12039555115225233754,
    2289682346552835935,
    14530489280951915185,
    9314547002722141050,
    15487402696134569245,
    15316058198749106540,
    8255908383989899596,
    429140967210001031,
    13040863854767973379,
    7491995439444125634,
    7409119301925388732,
    11467367335145788522,
    14782978042382863511,
    11461305338115534098,
    4995707884072977435,
    12484919016816100738,
    8831833725109723749,
    15313024837791584073,
    15651927501202321661,
    12051252567251113103,
    10414948505480629004,
    2978464179066000029,
    6193739797407617059,
    4482066987435736329,
    4162467826968844109,
    14667880832680257116,
    15984116788856562457,
    14966155731541076056,
    13762524314488572584,
    6951872638219921039,
    5677131062905332464,
    17491819218922701537,
    10727103652335473678,
    11113229307006755515,
    5372298848698710722,
    2737771468091992815,
    5215096071401518253,
    9721864048633056380,
    12291527878689873812,
    13434350825262958220,
    1515595756269125057,
    10803251898498990179,
    7976239671990644200,
    10272377489128221782,
    1497316561059390859,
    13265737383683179530,
    11445604422142647994,
    12446212912330766926,
    14608169403579836691,
    3955451023827764758,
    7705688628068590512,
    5313834699670756203,
    539578921746532997,
    17152880029995492099,
    8821014297992611975,
    7771407532869647951,
    3953993138833749471,
    1031208556298442593,
    18197382679062617861,
    9661653391417126017,
    10746660682939610113,
    11710045403601553279,
    12432849338929808982,
    5172285818124514196,
    16600155222402594913,
    7586697091160464814,
    17493843613975994383,
    898630486825477824,
    10895227846222953389,
    4738336960817183914,
    1686497541382624368,
    4174111447521040483,
    618115518600812602,
    11214664325099850755,
    8565396345799671536,
    7665935831164766248,
    9966955612738952408,
    1145556230626850770,
    11038877284916004617,
    11289524187338361548,
    7452493906481273813,
    4595922180798247133,
    16825059824939385726,
    12473249210457040891,
    2598549297366891029,
    7447386652159636308,
    14287197695127876515,
    15192462534665884108,
    16371089553587203719,
    13030388052721539133,
    11552927875237874802,
    4027285071800367105,
    2118859091975782172,
    9662698893851965499,
    446402768908213837,
    421235500682873916,
    4272804045131575010,
    11244572039222538306,
    18162814516067474791,
    17791947566192380944,
    3309395948033161021,
    15050518991069570929,
    4194324944611797523,
    13213589265199581880,
    15161490586757112952,
    14519710791725326653,
    8896479440827283443,
    18213479037323227837,
    2032866056386518422,
    4990317422310915559,
    8034110636043018415,
    17191507071137218250,
    16713027136517048866,
    10893737242768028271,
    2643628477498773567,
    16084200847071588768,
    14188067787511328886,
    14152309093883715042,
    18356271661542075034,
    10246651357143147778,
    3767502942956392764,
    8746303310766649153,
    10435795909821673013,
    14249899303517446152,
    6401443853513743339,
    15650399667357317889,
    2788717928286413628,
    228712618029879337,
    5542457926341586765,
    18373176626568118817,
    453600369976561737,
    6586517192497475578,
    16219365583524612804,
    8982080512533322340,
    3916509976595750506,
    11214856235108516757,
    14235300080654476740,
    9856635311866794224,
    5776907732476074103,
    2460667831826534668,
    7807139559826561981,
    14900790392503688899,
    547164762563249540,
    4250247873893361265,
    10694805233421566995,
    17665657156118578247,
    15057368230399632184,
    14606984861373699560,
    10329693202430115294,
    2003220194819619188,
    5384943814747022385,
    8648058707163914506,
    10842212061839318510,
    16685894948659947814,
    3680216087917505999,
    18164945876176413869,
    4539613065196752372,
    13050614296028048744,
    11197142485369653837,
    3583884432815904329,
    14686470249902857724,
    16328643500671144613,
    1955843031017521644,
    7240668148138171913,
    12290005550915864482,
    3690598835863246627,
    7861392073548035698,
    12179474636267714955,
    2549621832786405701,
    16642307163968885285,
    11393897831824675354,
    10313093276070908430,
    6750256035357252838,
    15334107932252633338,
    7274064875728926369,
    2641479258841004767,
    13503806941763579018,
    9469839270580460400,
    11929131802202505078,
    13612589039416089036,
    11650388278098490840,
    7391997297862945256,
    8214735315604789827,
    10449937096995948205,
    18160401542171192554,
    3920272347067923233,
    15167586240347943879,
    12025763370565386387,
    16688292387659419283,
    4663958058805351651,
    11832432764716165686,
    2473378843141377570,
    10576596076561538990,
    8305960500523582552,
    10809065870910955474,
    6386679743077535339,
    9494775389767766982,
    16567764471773946482,
    6391215999939167846,
    3068389956755890419,
    13499091726404084711,
    15654599626174671253,
    4264498139768337771,
    16405136182992500811,
    9258474283599356750,
    5151503051004590589,
    8363243641901963509,
    3305186059656956933,
    1772605054944400312,
    17599136168004042449,
    7316623589353757045,
    8073009335379428366,
    6511966574499986189,
    11861830733753525347,
    15707415890662522069,
    3933054731144699992,
    12412217784721758911,
    12844900122074439326,
    11766701158921614386,
    3374281566678728842,
    4763404221228871184,
    8861396834394691627,
    12215312576365223653,
    16040022189840236275,
    1027278353135035101,
    4007417887101261819,
    753812789869654241,
    11270692784370708820,
    4503294592131228535,
    436822045389096541,
    13325185527221777233,
    2972622228279856590,
    2064125588640781543,
    1131799674831824761,
    16512712331727801322,
    9430765712451398669,
    13523604461453489850,
    3868127293596790747,
    10592238112003480933,
    16002024694890875380,
    10903563885305515242,
    8941262524102171710,
    7810738262589205340,
    9504577043707041794,
    14695019996403386274,
    2899705167868973998,
    11941810263888905475,
    9875532752093886992,
    10420661737739626705,
    427679295561955252,
    14512750508594447662,
    1667798898423456299,
    8771547904622414386,
    17226840242078762441,
    18128290058319864575,
    440183840713564586,
    14477938554844604059,
    10679370485992366343,
    7792550545823848863,
    2939209277748035718,
    325480610738680561,
    10301883457484419229,
    14823454059683527359,
    15277014605936536709,
    11114580457276066990,
    11175606575855904601,
    1913987668451789443,
    15817951603746995993,
    3906191039898666650,
    9133718829148719424,
    14918089485283097785,
    10287949097906101456,
    1077119757052600926,
    6507986352512874661,
    6403895245384278160,
    13481528871565736789,
    14063824312594717113,
    7883133942172215153,
    12673755800298554160,
    7662765938645107085,
];

#[cfg(test)]
static STATE_SEEDED_BY_U8_ARRAY: [u64; NN] = [
    17126594252872438164,
    7038599580547221482,
    6650780259119354845,
    9972544303810706777,
    9356156878989762228,
    2645105490955261509,
    1912450326815221542,
    689550047180735238,
    10433137750649168911,
    12433466087994061610,
    2815294903909826272,
    13116216249008192373,
    11024149333230120754,
    11760116715842205217,
    6431909574967870761,
    2507467177197371439,
    13483670632829736446,
    1841230249149543453,
    16234151800352322858,
    6290187750947911069,
    16525963857503521280,
    12264360868787054699,
    3164908659621065854,
    17625451905615263251,
    17042819841296748105,
    12154024531553714366,
    16036510526562475697,
    1350758670081765979,
    16255433097461819089,
    17430718432335150769,
    6580090171143531483,
    10808197597814062114,
    18087164654670608987,
    1304077598598965838,
    12794286378384387790,
    11145783517379451920,
    3035872927404778324,
    10974510927407953919,
    11030956463105064302,
    11237607014283373429,
    7008839726874788284,
    1078524596001337126,
    15141701215130300199,
    17748937180434688717,
    17066270773019381457,
    1478422380606712275,
    17485341505075734306,
    6280186792667822238,
    2411570948221966312,
    13408622927457793734,
    3245161565751712608,
    9362876432617388560,
    4985852187517100890,
    9148875011257794776,
    12266545368193413377,
    15887569872466067448,
    14482013403751949937,
    12216370260069495363,
    3322558822387329381,
    16247374093872089979,
    9021788598514523048,
    17734171970299449039,
    7404239601042761314,
    6092751664101625896,
    9928812499046932596,
    14470139463175431114,
    10186211120463402182,
    8115852706201279988,
    1161492789943193267,
    14053273680044720381,
    5900010615247955807,
    255736930343009315,
    15436875478138651169,
    13680542807041533035,
    4483831879580281729,
    7450182847119114041,
    6130408323405375602,
    4682088506663159388,
    11153394196409002617,
    14572588358597252432,
    7602547691922769818,
    16704088147124105839,
    1230042992099530625,
    12626149048295608392,
    4354059916542670752,
    7968457524827528292,
    4058484937846207082,
    2507552215396304008,
    17706511206157221055,
    6829459569388080890,
    2023083078031352711,
    16350532255677592956,
    46020308094417510,
    8467955067291885810,
    5714152296362790446,
    4507284317431864669,
    17979943464908311768,
    6044916359654557040,
    11649682243437580751,
    12846513744129389619,
    7239278633991339538,
    15720820789379777284,
    4814594181607694888,
    5080561903691943947,
    5217256292315654168,
    7224533561145943156,
    12657467954886341099,
    17738077991120546698,
    10419724296817584337,
    2144019716274066163,
    13409710947237518604,
    8398701084985686626,
    5617625541780335023,
    16142901608919361567,
    16445088540264520132,
    17530758983652973455,
    5938211130875599285,
    2365443188445600113,
    13448065869207050551,
    5875156261453684682,
    5672777766015351895,
    17417191419800007828,
    6900194012681904810,
    11181548710178797661,
    4007561749574154026,
    2442109469540894915,
    2387264402770560875,
    11193492516131537828,
    3349429886124601585,
    13706790511416595548,
    2613959764291176655,
    7309047737037254039,
    10883364471468124504,
    16812133216502363124,
    14176756638512916291,
    2228151320822084958,
    7873718156657955981,
    14815502930777892387,
    4265340264428629265,
    1211559558922978275,
    4251974477651683085,
    8440248187457081657,
    2512301506275153448,
    10637679365846135251,
    8154127106621839108,
    2343760936841157351,
    12620150843782158243,
    11800199519322525358,
    5552242838007352867,
    736471485552778646,
    17897155338936177746,
    3503756705499948819,
    11471593996821577525,
    12230103050755983402,
    11922734848238278670,
    3641956674226735404,
    13905953431095695174,
    6608810175044458686,
    3072545215858882232,
    3028161448974142748,
    5615412929134456614,
    3024566545485593724,
    18259044407213772068,
    3657408090136896533,
    11450460499311619552,
    4808503780413197018,
    3843218721412790680,
    2074041965956569231,
    12555039292162098961,
    10036664215642883596,
    8744304325187675615,
    14465409371542841056,
    12195550388153621400,
    8675705628740914553,
    17972584184326414037,
    9162804123022453200,
    8507552727307227338,
    7917481605555474737,
    8318630774036788360,
    10550322565585452685,
    6400135744675868334,
    8587590933319581104,
    9348654306974052087,
    15806324081120645780,
    16534882464344674257,
    5769826492946742383,
    9120100065746152045,
    16716032773430428564,
    17368916320678293813,
    7055304512580708731,
    813274473551973264,
    10456157704106793439,
    14089590859434053472,
    16368987843492889203,
    10837684978380360791,
    7628595938139144996,
    11883281148012106047,
    13282060207237175400,
    14887379653080294912,
    6950877941096263821,
    17293737467431878293,
    14499478317497271144,
    16201952251925048970,
    8915486808892247622,
    11578798772623955114,
    5157436087165014469,
    1601036630339767588,
    16735931483428339822,
    3154392864614313627,
    15502222015581100159,
    11382379673430413069,
    3082056106685678987,
    11474295445045834531,
    18221767367880100708,
    559240243582607096,
    12453907920798200690,
    16919525085703328347,
    3766447151387088514,
    481815576282753508,
    8914088649700597471,
    13759483378645216042,
    13341072918706656299,
    14158418656441746687,
    3307902878810135594,
    17160928453603440047,
    8632345710606990337,
    1665899298308512987,
    9610550089446724777,
    2996653314075499222,
    4802352623587066076,
    8795211670178041300,
    15554919298753550987,
    9120682774307214660,
    7149449581585188121,
    13853061484479653598,
    8308731327584530172,
    5542017368927130890,
    7504930505134130392,
    5439289888925098638,
    17613858830986217715,
    12650742215356564052,
    638813074339181404,
    15690472686375956916,
    1166856914534497235,
    464884767106120752,
    10652156405367750945,
    17506814379083632341,
    4308707444476711448,
    10230108102826498527,
    8294922140632214170,
    14939315972608761646,
    1552556823730855374,
    16170577931911461384,
    13409174189005999,
    11795613299048383381,
    2841107321804907654,
    1847921935357069769,
    185859642690547143,
    6718602404862247358,
    3907372639507980630,
    3115534878252269269,
    13438941054830887633,
    1677719101059655838,
    15316582065671667799,
    14344115984323530736,
    10453254687410595794,
    13554059608554863504,
    10941924451961143237,
    3411666101123767329,
    14476989716180708723,
    4112405272069613738,
    3305472362296160025,
    5002462223192979620,
    7676352581546761148,
    16016375213571411999,
    16794974471508904769,
    12487377076352714657,
    10359077183135488625,
    15155637060908450753,
    1283124906612920745,
    3615563123784959882,
    17700935241264310441,
    12093573669060059295,
    13635085910476828370,
    2620268962247467257,
    14262025986500585913,
    9994463742599356817,
    5598468670525521165,
    2859714628456671686,
    16213838736605232463,
    4865841823122578700,
    11496350818411326954,
    4495839426562501578,
    15786607411817057662,
    18268958912873132359,
    5057077392567481052,
    4376551561326520879,
    3070560671754604589,
    10437019897367751414,
    1853912398969330837,
    14092562496523528913,
    196339245768088220,
    14646581294026542822,
    12178765420743986431,
    943616316905240095,
    16605167405837999920,
    8361213528495744185,
    6460942813346512359,
    2798307966662040464,
    7368296346831538977,
    10580767609227690252,
    17732730325348202141,
];

#[cfg(test)]
static TEST_OUTPUT: [u64; 1000] = [
    3240292822671861499,
    8034436964852289123,
    9983876484956145066,
    4599886402440295616,
    2863882179937900803,
    14893227450921927739,
    5776687890969795684,
    9954695313158138638,
    11542820839266690502,
    18095968094765073090,
    798808080085155086,
    5777776777378700815,
    10727774008559880651,
    11853162166983565668,
    13798263452846549532,
    3751012118666791749,
    16420455253439487777,
    3090069591349790302,
    5873867693178433639,
    15360957758422068856,
    3623409443222754776,
    17649660566353726897,
    8139262188842031846,
    10906673920109318795,
    2575196132144626242,
    4228895125260581157,
    10553962057300113577,
    5923429982599278086,
    7878734113380374350,
    17763241295797750036,
    10179780230241011354,
    11251946326684531919,
    7188010474743130044,
    827985337143235386,
    1109069966310852454,
    5699882667300059967,
    2311415247154147955,
    1287503911296968902,
    17503358830333657434,
    17074858671284735587,
    1164171519628064189,
    371851500578640591,
    8275272956824377319,
    2346586246368478250,
    5823323730359300559,
    16226760602602856433,
    2729486254021987516,
    783574614095704127,
    11976002413283819922,
    9234932354986919963,
    4335726558699783484,
    14967375735903832528,
    8117409175651274147,
    3292234063795637463,
    11337618793873590245,
    11692448715959547882,
    17472493543386974719,
    73816282066474254,
    14189860886311999147,
    1155299830109095651,
    15711261681146684195,
    12114598522412800442,
    9726013675959219321,
    14940956627893276826,
    13880483448681415514,
    5432319057916686584,
    15489839638348982327,
    15956067291386570038,
    17293653328648300136,
    8359378865057033868,
    7988453446769046342,
    9376230829434395345,
    11652451569037990053,
    5385208773833310804,
    6262954580134209879,
    14840830371502015865,
    6013242072328629209,
    14451632072608928540,
    4001098642627377616,
    2041434915473522346,
    2190399290824293562,
    13112480968556348988,
    336951641574493274,
    10693591302015225106,
    4291946967709256852,
    14217777479414394521,
    17910224027716823638,
    2378324184964207421,
    3338638980691064566,
    7033560382391664778,
    16107836499276780137,
    125439828527371537,
    17065453135992138552,
    16011549967738510955,
    13567953973970576541,
    5293012372749916807,
    14587300251980636038,
    16161935244994345107,
    18203945235791043069,
    18046039518371082625,
    16546197789963193908,
    2591943982877938574,
    10638594183811798016,
    12729636342088329300,
    6197630400874523030,
    2453151853010009422,
    4293539817176264866,
    18141004105045277403,
    908856592314079634,
    7287897851899500590,
    12817671421267317421,
    12322882382318303279,
    15747929718292678144,
    1976075002466316969,
    10390526408619004262,
    4160582686108848105,
    10673705767017112594,
    17616885586405549674,
    1132157031348876601,
    9830973161358555692,
    9540265309836418795,
    11710427684492428734,
    15340929417236692246,
    1371662210438627513,
    9056149319467239816,
    4483273264548250322,
    2229252098253101709,
    6640968261800973620,
    15315318789350789916,
    7187891549042933718,
    12674747581461886996,
    6974264358729756395,
    926878598554277398,
    13866049460520423537,
    18310978099906527078,
    13527268778913509611,
    1046884876326828907,
    18226523912093801902,
    7245721869302427558,
    7909959235129630453,
    14241764016572517945,
    16236826120084980847,
    3702085267246991613,
    10014819403900040304,
    7124616632274831794,
    2973494732879385736,
    9357698219388198878,
    14919694210987950355,
    12385046040655860971,
    10495376521799969118,
    15375374378851098381,
    12691509755257021366,
    9047220027148989984,
    13858034705379911603,
    4939294268676403736,
    13269061112360416356,
    5429806843628024445,
    13460740991477699197,
    7711344228752270639,
    5837773323941396836,
    9181872809299114941,
    17393475502221876493,
    1985871717948144418,
    9358721182003181543,
    6276896994356930878,
    12080719128715820320,
    10207791701875480238,
    4186467366283524955,
    15456643026128760196,
    11063718458717670956,
    3728889181609237379,
    1817648464140138648,
    661955656431116398,
    5734682454132146028,
    7970819302801304803,
    16935041941538129365,
    10612850140181114391,
    3221309169549877494,
    6705406946786099024,
    2621669827937173240,
    18169393212175831524,
    8980563016113328318,
    17986303162866520095,
    1086338259899129938,
    706385019345150370,
    17868272377899658546,
    13640040192153852079,
    9271533464461314953,
    8088449239618662140,
    2161994577101352988,
    16039210092332699306,
    17300404144925061497,
    5858612155981109342,
    17231683423977612946,
    11726978717479746665,
    10316790293351170982,
    11053152528112103146,
    15582979991746598078,
    11099668250859431956,
    8152882775475559337,
    16971109094847659980,
    7565140245217693444,
    5749751973203281066,
    10725057532249983763,
    12146213493556783554,
    7876030173123351416,
    6971847622979881427,
    6671155666805784266,
    3504623058387452364,
    11332849218997120444,
    4693532200250803636,
    16992857110738320231,
    10992550701120180987,
    5790548673893125072,
    8910893146680825019,
    5987629423727104898,
    10788418855108218984,
    1909048702007575758,
    14746315860764754768,
    7331648084292485842,
    10884511179415310603,
    14693445153233559727,
    18189623835446816040,
    13186859145405576831,
    444422140508057268,
    3013832507935235847,
    1097692964292817201,
    878131599219642413,
    10471744132642742336,
    17036671066116942636,
    8097731437038953872,
    8227731001365321544,
    12603824609903789289,
    17094094487410828172,
    2428862565995760480,
    15944417105692879975,
    18260290001155267937,
    6793276983882699888,
    14862015944593804105,
    6460868575448750400,
    13631871406333336721,
    13076186371648940243,
    16243082056050034056,
    4013065382818489674,
    62304318084098103,
    487631513605594119,
    3355716872498308413,
    3014562492299685307,
    8580997642633178444,
    5247846403930118203,
    15708257321416340279,
    5548264268561832103,
    17427142736862858779,
    17750361416457476340,
    12479894309747924351,
    11794672037563250428,
    1903724719633953445,
    11071093839771671698,
    1682534179964314546,
    3317396398296711462,
    12365254289288548430,
    6496445313621990501,
    16443188745315829448,
    9156810636609422172,
    1026765314096243443,
    346113372795614469,
    17668840990863308460,
    8223657398663057999,
    3971798866945153724,
    4056983213693072534,
    8694714992842090417,
    5252587456901943997,
    16117101493509910308,
    11985114552674797529,
    13666039671283351371,
    9614949845685516445,
    1157815786837915898,
    10680411158452615332,
    15796960991530078177,
    7628746143153784770,
    3982998639405821732,
    17645683535916296937,
    1688160228142695977,
    8362970845782517217,
    10914139270977525379,
    10689898479632810325,
    2628738360581778963,
    5156907990670720600,
    15144541356793024563,
    14913279557566887699,
    7246013016429267045,
    15013621285081618712,
    12164559502819905863,
    8258086877453882684,
    8599009856924162632,
    2428760556087030747,
    15798247285937002341,
    5853218529542669331,
    15920726124361763050,
    1146576503475577214,
    6648900947831369280,
    2441484361096275502,
    12261607060795050607,
    11617785121086386820,
    15157214007698912867,
    7658737318538076312,
    9307621484533830524,
    5825742360720203144,
    14648466553525223577,
    11049184987277858520,
    14069044033425262839,
    16905617609495380973,
    1471007158905686845,
    5550614478757929610,
    5985952484181135638,
    16391707539394979270,
    14861467148021960495,
    1739648414840484272,
    13589135143656016985,
    10591485850549153856,
    18275566887994213765,
    9187457497402310063,
    12964864249123904755,
    17714274104363865058,
    4991398711321841583,
    6273664156330170237,
    13829175885238309567,
    12372968657629179163,
    11732821764594079023,
    186435185347226841,
    8622547640473114869,
    13109239136411886494,
    12984337990219229584,
    7010014058356472817,
    3220686261275066472,
    8402128370997200829,
    9448447647327035663,
    10231612275767560974,
    13174039154203020111,
    12541596077005787261,
    9265930553646985428,
    5564675234895435576,
    3352629476333083986,
    7636548577863853436,
    1401994066264064159,
    7767838235377887346,
    13657319655141916923,
    10122774510512947791,
    8496479263343054893,
    2922705059213649847,
    18305875813547084999,
    13185569723691743848,
    17951198962340979651,
    8797293302336617938,
    1861126810821704983,
    11388508744992506119,
    13244675768255377342,
    7094320100550167194,
    11147521052241287716,
    7536930307401346635,
    11881620000476735207,
    7046434057385668049,
    5774151617872049077,
    2282167636243079050,
    8516951359679599325,
    13661023490731276133,
    9903307684891591714,
    9448442287036117219,
    3871621590669223973,
    3643911752722914787,
    9878646471116315520,
    11427036489143194657,
    4584735048370777761,
    10085595996275369307,
    3839814223031278237,
    524076989937010215,
    12495060410802564228,
    5372783684749557623,
    13479835836380862961,
    3063348042748202917,
    16909523161339866978,
    1164269104338546542,
    10713547276024828792,
    11566811466567837037,
    10340745343095473159,
    8877447837481931023,
    3472399329273553617,
    14452132552086037868,
    9680215211489288469,
    17972874109048883581,
    5360323425334526670,
    9522925141480819973,
    8947017802780286202,
    8824444748842515597,
    15134009152026361564,
    16365393990031872574,
    3318924607324325043,
    4214497027027472341,
    1532547462099994302,
    2573304690392813898,
    4086407507616520247,
    14248618008810814152,
    13203000944653630783,
    15459790301559053897,
    10812081618528245766,
    14305526333923083502,
    2634167401024279158,
    17433917324001633447,
    9007634845645468929,
    8027716560810832164,
    6099952175111800479,
    2196552157609821817,
    13367720971039496353,
    5971622005884222865,
    16737710303410459271,
    17596234924611634336,
    12804557811294225518,
    2608055766996801802,
    11386835350318383350,
    16662100753677812190,
    3971119784132640008,
    764895467195090957,
    10550149523791339601,
    3430214553109504867,
    2090380151315627614,
    6227848947157492355,
    6921258603793378577,
    16847860353667542048,
    10655941676984125740,
    16197428920924701823,
    352282209188564431,
    11662309699456551600,
    13803475347643623436,
    17138425235753043250,
    8359824184196222701,
    18263569806400461203,
    8756407133816786714,
    13966803226718197921,
    18120093616507058884,
    14747396725362099422,
    14014309672570320692,
    11989968992013252703,
    12907788558713597204,
    8013897146877672698,
    14129567546624378994,
    683049750306734360,
    16493207058062129592,
    2784654748440243790,
    619346695195863249,
    7050137429459076553,
    10705124242557794003,
    13495034372354816105,
    6587767576351164389,
    303195989151342364,
    6137551284330170956,
    17211780843686875623,
    5896640056300229660,
    1467098016679374415,
    1492790599146025779,
    8738551234809107085,
    12663311139835292695,
    8650938810208643277,
    8654155988989022585,
    6285568160630798921,
    10297700016937145404,
    14162478140273483939,
    12991770674529431790,
    7478027320509518773,
    7290576949875565832,
    8233921825744930662,
    11324450454158043958,
    4146076400970400247,
    1393799908012636376,
    3439560442992407586,
    12402668852605968340,
    30031558653736035,
    10924835565843129090,
    4169355397903155890,
    13707605986256820439,
    14074593590126466601,
    16223595393946269685,
    10387898165965204042,
    17253779978704004278,
    9008516522773897518,
    4192298851907609721,
    16501448004994072645,
    12069472700914412602,
    17608950812919998330,
    18308874171446241558,
    16320731017507339737,
    16615206929137617845,
    11774901071107614203,
    6883666659347634642,
    15326731480834175488,
    14254216978787898989,
    15944095766959504469,
    17231980926556602191,
    15095104620297168009,
    3181933243423535848,
    13104678628896016900,
    15173225780624218264,
    14372776431022819910,
    1287117180253779166,
    16225048318995001966,
    7798776463685445312,
    13521777279555932638,
    8342080880162213658,
    7949101982239585556,
    18123234029168985630,
    5920089299792374555,
    17742276921378775061,
    7418691026150068344,
    4780864965322664233,
    4234732004467544443,
    16311845102790969827,
    13015635614829705003,
    6502825650176823526,
    15397122702177679668,
    17216436545138569204,
    13681648958476715295,
    3534062476738360213,
    6757707807383542595,
    17349730352038703132,
    15054328789777921831,
    7675661363657113039,
    1322539019932643044,
    17194388242694799813,
    2402931610525914181,
    17548366874977444467,
    4044552338381951971,
    629452902441287267,
    11155595422181544877,
    8379555335570742923,
    11314379589175678833,
    16602101066937669423,
    4239555631511231664,
    13229956331531125494,
    13890539389961766563,
    4871670791913872753,
    1946643961722630346,
    2762941402780859817,
    18330536762654509644,
    6200100507342887328,
    7128609489933739280,
    14707586739893403136,
    15765233927604416025,
    2664428698958951061,
    15368640918753519267,
    10202167614755898590,
    9523064885858798568,
    4942447142641070362,
    5006079054651967979,
    14986111919819892078,
    12644475910221542533,
    11883015465048070712,
    897598587448027414,
    5889771826106330917,
    4794067650168924515,
    12136222203017520591,
    14742146421680787145,
    12387019513552266147,
    9183394321961931788,
    17872908450543830615,
    5349177237150723703,
    9550555756158625431,
    10186283438215528333,
    4927189746214444018,
    224450762062579901,
    5025915301505692765,
    16047209163480037226,
    9827026429953823209,
    8016431127690882455,
    7824379864937334888,
    8695766505755940696,
    237476901546897675,
    17948417171027618332,
    10526202454475009423,
    14020040913336738249,
    18202716711393702548,
    11198820901960104006,
    2794186496785200115,
    14943257154360174117,
    15435914309757374113,
    4652753776917124093,
    7443909608553035870,
    7257425023602450849,
    8511142526647398490,
    16300757050556545686,
    4231689935441999196,
    2928980691617748100,
    17740675439029174778,
    18162941923321607173,
    6612489869849749201,
    7169575619592330536,
    4859591918326057659,
    14789959073516690487,
    1268613566924843552,
    14001128046964785769,
    8239416132070132265,
    3136345394212035657,
    7430964720631115317,
    2588883011390655980,
    11076025975632421530,
    714276327857952611,
    1144873749294523735,
    11607851074766847996,
    17827685162343072609,
    3982117922011346108,
    18367164252244748061,
    11054392892502390007,
    280545818451097183,
    14202820865892911361,
    16032229722104419130,
    3332807622084362551,
    1881533169676941818,
    3042415739464646126,
    7810807071868729813,
    15459903686659602346,
    12275455467675834880,
    3516705530131837632,
    6662795908171334537,
    15855363227493898499,
    15219188797643249571,
    17977716316268571126,
    16843126617980698795,
    10107216700575311297,
    13093422264272893607,
    6171650677755218773,
    5299755276342312757,
    4342598825548988340,
    8118340773186172726,
    6189682901797946894,
    2547119621572850243,
    3571757185809699206,
    10929823114609292423,
    6890059854226375738,
    8567249200756726504,
    4716718552979904571,
    13897802333764581848,
    6785670847825630391,
    7403953146081483417,
    13448890032575759576,
    16510391413264657140,
    8901608659084633907,
    12759507318542953654,
    11533106658270425329,
    1074623523291963608,
    15549066587031312155,
    7598688323611543975,
    1312117544087937217,
    16865852693329606425,
    12932048953554125036,
    1719661589665527304,
    17084031579267980430,
    18253119400006322328,
    5046532999534817557,
    6903833951491095888,
    15016159033962312398,
    3594971715896134012,
    15382929684271414881,
    11524896629701303540,
    517415614816962545,
    14539682010980779196,
    8335363598128729339,
    6779408867729141088,
    3707538378087452903,
    8687062835761744036,
    17009794942721641061,
    3536435299442291863,
    1854922145770187104,
    10176091547399533123,
    17804629333516496277,
    2191647407746797171,
    2071159092338014690,
    9470207577482116166,
    1702568111533248790,
    6659727708947647152,
    73444908155372047,
    16957445076270304075,
    519605424466144767,
    12401769311887980090,
    11790433690203758141,
    5437151375402425232,
    12179809065541804174,
    17532301169786778736,
    13520496500204659027,
    3624345143344985940,
    2552800864398383592,
    2205023427253403306,
    13872372244904054128,
    1458636776369888057,
    11234990687459553436,
    4130152914721906493,
    13606221932842437301,
    16872752533260449175,
    9725107720298058630,
    10989351369476131882,
    1086125810991240751,
    17892361045965705346,
    6248429732886324235,
    4195216903086690302,
    13136213825966636523,
    3982484830514962020,
    10270211131666248357,
    17088906760007096944,
    17953555697867811383,
    12396545903384802440,
    6993028946385827959,
    13511877103215456804,
    8268776146453517788,
    14068706913748619946,
    15667602302004859871,
    2889655496499352656,
    3248951205145064023,
    4130807414947597345,
    5619588423025141622,
    11371254065784093238,
    5284793670851136030,
    17121482724882139467,
    14450149015081673631,
    5799352384104054115,
    5038731800761821814,
    8232361050200910498,
    6053425310269225880,
    6962999816849868275,
    12409125189736647606,
    5133570090929929103,
    2622510225053392908,
    1359119189126211883,
    14249597445447117436,
    253047620644659064,
    9751419932352656190,
    13864408898121820523,
    13533233708042173882,
    13795063547249824731,
    7823986049034384496,
    6063241802891610644,
    7282046316291766395,
    1115071483743722376,
    470845170527983394,
    2974573682154127846,
    14065624947057710062,
    14489247248734196471,
    378180348911405789,
    13359715235065475540,
    11629424647325528960,
    10021053683521954305,
    7289759905565661843,
    11924694100854735314,
    11757745857909701346,
    3165827664501399740,
    10358156181168781892,
    10371527633780627920,
    3252032248315780441,
    3013432406469516481,
    13334341205381161270,
    16556945924697224364,
    11095828541404437890,
    918438649288676683,
    5291566981723816875,
    17858519451489820382,
    6128529574593956828,
    13998011065903097696,
    1256463380004727584,
    884406064860108651,
    13033391987917094083,
    713368719455495883,
    15193307504077050505,
    6891003541149467604,
    4430476325912746962,
    8418815785628032499,
    12084141579223903103,
    5551870433040495339,
    7257470019349532321,
    10955787502170608623,
    17526340490160319640,
    6668998517275467853,
    6722536363658465679,
    2105771337984665886,
    3476209147097447193,
    15497368077394924543,
    10403427667829088249,
    1534507401222167084,
    6229384176008284084,
    11339419996705188410,
    497449123931823176,
    11617072680136422439,
    16490753221321955746,
    5984005314289465411,
    2407786495820569130,
    4530909083643127969,
    494148863706513665,
    2027744260528383446,
    2762490469304512172,
    595943770178570060,
    2521911966798396776,
    5532025782686506799,
    9883472941551302095,
    1339234801298163801,
    1959270183759727543,
    14869428416199312253,
    10966069868435864095,
    7883135941143499227,
    1868495147671065863,
    7494840378632018267,
    1229864102890858143,
    10848526449530884079,
    5768497347350979749,
    16035009165151424245,
    1581025348906266368,
    12563154648244493155,
    10803689326993370512,
    17484280372879349838,
    6334574866497848672,
    4841050343446804472,
    15883532178309184289,
    461841454957477849,
    14881999523830254877,
    4529396623608984753,
    4187590244905991889,
    3961838842561096349,
    13573572564249601987,
    6802678198300868837,
    16912363814791333896,
    8577229377513749861,
    554343630044829518,
    13201593953987687338,
    13504535852016189862,
    271405412707347419,
    2807338107762122101,
    517819137574728350,
    15497147193387684212,
    17248188943525774703,
    8079946200171966349,
    17103732696209858146,
    660574403104787206,
    3576712189771756835,
    16748768309398859874,
    13849443092535258339,
    5444580288683263193,
    12382233408469000383,
    7843706172657005008,
    5833039914847569747,
    16871012768358492906,
    11963394187713904185,
    8168479620164292687,
    382792673913543870,
    4365241777568748652,
    14851608478886986502,
    4382953302925128000,
    6426028536990331331,
    16413338459013042429,
    2002946974408643605,
    11644546091985379762,
    11389870337042607606,
    11438813502704234246,
    15458991295422071413,
    15934524144969757212,
    11090966815049770034,
    2528759254554284948,
    8113069776251976882,
    8795808478608186181,
    7429471443790450364,
    10377980577197130746,
    401409961826854504,
    17926174846143982397,
    8579968549622558165,
    11896545688329578813,
    16589372169931937353,
    1196083825901778882,
    3407177376914500425,
    15430964155713808719,
    12022841953890996822,
    6799227372823657762,
    6450906872075854612,
    1988534513887093388,
    10444694277587101235,
    8625091726215334463,
    14393353036043987702,
    9779286486560300815,
    1051188470795538110,
    2502711113477980033,
    10461271459614384597,
    10474845211311775048,
    4868498985881601117,
    15075952909897476596,
    2177118098745671516,
    14255355716351797372,
    12954034593971199578,
    13601570941791234005,
    1632145975996727283,
    5871664790281209908,
    12827941208828583599,
    1050417144612460376,
    2220131534224960449,
    2279138357454562206,
    1478911309061225991,
    8852421660244383813,
    7464675779499348489,
    17728434633001024032,
    12175567603271351995,
    4657667322309887730,
    11093687558160511047,
    10467399655126177085,
    10847903530832814465,
    4620188520368678069,
    8948839711193375767,
    10351020000571180582,
    15230100538585569120,
    13419219431915601809,
    11347664186897182524,
    11470404597820289859,
    7739957659078009192,
    14288302945122256165,
    11353305835633512965,
    16364487838873802036,
    994942771637145696,
    8644030903339726517,
    6307608400737363569,
    7587575440434454570,
    993530794904271751,
    10453224689280301542,
    6465775579698348292,
    1328244514903318011,
    7345300693895754483,
    2728113277444322260,
    9779766084410865261,
    13377578284550607182,
    13816225147772183546,
    10149930201388769350,
    343730320698369008,
    18251338088431625389,
    6175230397317576769,
    6559117913386386457,
    11428734507675523932,
    15891143549185725392,
    9587334117005031413,
    5883896726040426492,
    10961390098301492493,
    17784063834408923801,
    14333672862170645880,
    371992348178856182,
    14660832735486880183,
    12730015487149814813,
    4818322600248335030,
    9327113063165227938,
    9344554222003967209,
    13722299469662519880,
    17525171074280787821,
    17085636233895908078,
    6661455266250357714,
    2909362540816916463,
    15952678106391285042,
    16662899788975780185,
    17198428061275809252,
    7473657931507419341,
    4699799840074390621,
    4272201847410275490,
    18203179844699379501,
    10988814471114224461,
    16080859431073433217,
    9301648241766094886,
    3379190963243858800,
    8330694278803291178,
    6620889604082638653,
    16035187507147554939,
    7997410407617821567,
    3102147627945859115,
    2686122046788582797,
    14128173576684612403,
    315847793971287837,
    4557485119351276439,
    3063119264283294781,
    16024014222581393242,
    15615105699595311970,
    10675191364080479901,
    3033015394049660284,
    3452730869854943210,
    6344093917230043156,
    4998228583132333378,
    2367808990295335898,
    15492812316681418815,
    11688385887044028433,
    10176196497015849196,
    14316301065828383546,
    18051920500792219861,
    6243390938654261353,
    13604384436594783242,
    16167569155344533192,
    954888933573135896,
    4495945882761403022,
    18320540700613093337,
    10345420916075035936,
    11181433975454028791,
    10489907645345326558,
    2110415442111442600,
    2863016781230371329,
    11961988341232735794,
    11398997676056240145,
    17311152866046037342,
];

#[test]
fn test_untemper() {
    let x = ::rand::thread_rng().gen::<u64>();
    assert_eq!(x, untemper(temper(x)));
}

#[test]
fn test_recovery() {
    let seed = ::rand::thread_rng().gen::<u64>();
    let mut orig_mt: MT19937_64 = SeedableRng::seed_from_u64(seed);
    // skip some samples so the RNG is in an intermediate state
    let to_skip = ::rand::thread_rng().gen_range(1, NN);
    for _ in 0..to_skip {
        orig_mt.next_u64();
    }
    let samples: Vec<u64> = (0..NN).map(|_| orig_mt.next_u64()).collect();
    let mut recovered_mt = MT19937_64::recover(&samples[..]);
    for _ in 0..NN * 2 {
        assert!(orig_mt.next_u64() == recovered_mt.next_u64());
    }
}

// Note: At the time I'm writing this, the `derive` attribute does not
// work for large-ish arrays, so these traits below that are usually
// derived must be manually implemented.

impl Clone for MT19937_64 {
    #[inline(always)]
    fn clone(&self) -> MT19937_64 {
        *self
    }
}

impl Debug for MT19937_64 {
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
        f.debug_struct("MT19937_64")
            .field("idx", &self.idx)
            .field("state", &&self.state[..])
            .finish()
    }
}

impl Eq for MT19937_64 {}

impl Hash for MT19937_64 {
    fn hash<H: Hasher>(&self, hasher_state: &mut H) {
        self.idx.hash(hasher_state);
        for x in self.state.iter() {
            x.0.hash(hasher_state)
        }
    }
}

impl Ord for MT19937_64 {
    fn cmp(&self, other: &MT19937_64) -> Ordering {
        match Ord::cmp(&self.idx, &other.idx) {
            Ordering::Equal => Ord::cmp(&self.state[..], &other.state[..]),
            ordering => ordering,
        }
    }
}

impl PartialEq for MT19937_64 {
    fn eq(&self, other: &MT19937_64) -> bool {
        self.idx == other.idx
            && Iterator::zip(self.state.iter(), other.state.iter()).all(|(l, r)| l == r)
    }
}

impl PartialOrd for MT19937_64 {
    fn partial_cmp(&self, other: &MT19937_64) -> Option<Ordering> {
        Some(Ord::cmp(self, other))
    }
}
